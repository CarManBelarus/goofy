## Преимущества

- Бесплатное исполнение по расписанию на серверах Google
- Сохранение [истории прослушиваний](/overview?id=История-прослушиваний) до 20 тысяч треков и история с Lastfm
- Фильтры и рекомендации по жанрам и другим параметрам
- Получение треков [отслеживаемых плейлистов](/func?id=getfollowedtracks)
- Перенос треков с Яндекс.Музыки и Last fm
- Агрегация плейлистов малых и средних авторов
- Создание плейлистов с 11 тысячами треков (предел для Spotify)
- Поддержка кириллицы (названия, описания, фильтры)
- И множество других возможностей

## Отличия от Smarter Playlists

Главное отличие заключается в способе составления алгоритма. В Smarter Playlists визуальный язык, диаграмма. В случае Goofy используется язык программирования. Нет, изучать программирование не нужно. Достаточно скопировать предложенные шаблоны. По мере необходимости их модифицировать. Ниже пример для сравнения.

Пример создания плейлиста в Smarter Playlists. Алгоритм: взять треки из двух плейлистов, выполнить случайную сортировку, сохранить первые 50 треков в новый плейлист.

![Пример создания плейлиста в Smarter Playlists](/img/SmarterPlaylistsExample1.png)

Теперь пример того же алгоритма с помощью Goofy. Объяснение работы кода в других главах.
```js
let playlists = [
    { name: 'Микс дня 1', id: '123' },
    { name: 'Микс дня 2', id: '456' },
];

let tracks = Source.getTracks(playlists);

Order.shuffle(tracks);

Playlist.saveAsNew({
    name: 'Личный микс дня',
    tracks: Selector.sliceFirst(tracks, 50),
});
```

## Ограничения

Библиотека подчиняется ограничениям со стороны платформ. Ниже описание конкретных показателей и на что они влияют на основе справочной информации, предлагаемой платформами.

### Apps Script {docsify-ignore}
- Выполнение скрипта (6 минут / одно выполнение)

  - Общая максимальная продолжительность *одного* запуска скрипта. Как правило, легкие шаблоны завершаются за считанные секунды. Приблизиться к минуте или нескольким можно в случае большого объема входных и/или выходных данных.
  - Например, функция [getFollowedTracks](#sourcegetfollowedtrackstype-userid) для пользователя [spotify](#https://open.spotify.com/user/spotify) и аргументу `owned` в среднем отрабатывает за 4 минуты. При этом получая 1.4 тысячи плейлистов и 102 тысяч треков. После удаления дубликатов остается 78 тысяч. 
  - Если для 78 тысяч вызвать [rangeTracks](#filterrangetrackstracks-args) лимит 6 минут будет превышен. Но предварительно отбросив заранее неподходящие треки, например, с помощью [rangeDateRel](#filterrangedatereltracks-sincedays-beforedays), [match](#filtermatchtracks-strregex-invert) и прочего, можно существенно и быстро снизить количество треков.

- Количество запросов (20 тысяч / день)

  - Как правило, 1 запрос к Spotify это получение 50 плейлистов или 50 треков. В некоторых случаях 100.
  - Пример выше получил 1.4 тысяч плейлистов и 102 тысячи треков за 1 735 запросов.
  - На получение 11 тысяч треков плейлиста 110 запросов и 25 секунд. Примерно столько же на создание плейлиста с таким количеством треков.
  - На получение 10 тысяч любимых треков уйдет 200 запросов.
  - В целом, сложно представить функцию на 20 тысяч запросов из-за ограничения 6 минут на выполнение. По этой причине можно сказать, что нельзя обойти все плейлисты роботов-пользователей с тысячами плейлистов. Но личный профиль или средних авторов можно.

- Выполнение триггеров (90 минут / день)

   - Общая максимальная продолжительность выполнения триггеров. Единственный способ достичь предела это вызвать 15 раз функцию на 6 минут за один день. Сложно представить задачу, которая потребует этого и оправдает себя. 

- Количество триггеров (20 / пользователь / скрипт)
  
   - При грубом описании это 20 плейлистов, которые создаются по совершенно *разному* расписанию. 
   - На практике, несколько функций можно вызывать из одной другой функции, что позволяет создать N плейлистов за один триггер. При это один триггер всегда занят обновлением [истории прослушиваний](#история-прослушиваний).
     ```js
     // Один триггер на функцию, создающую/обновляющую несколько плейлистов
     function somePlaylists(){
           templateOne();
           templateTwo();
           // и т.д.
     }
     ```
   - Кроме того, можно создать еще одну копию библиотеки и также получить квоту на 20 триггеров.
  
     > Если вам потребовалось создать еще одну копию, можете повторно использовать значения CLIENT_ID и CLIENT_SECRET и не создавать новое приложение на стороне Spotify.

Остальные ограничения Apps Script не относятся к библиотеке. Они связаны с почтой, таблицами и прочими сервисами. Или недостижимы из-за ограничений Web API Spotify. Подробнее [здесь](https://developers.google.com/apps-script/guides/services/quotas).

### Web API Spotify {docsify-ignore}
- Локальные файлы игнорируются. [API не позволяет](https://developer.spotify.com/documentation/general/guides/local-files-spotify-playlists/) добавлять такие треки в новые плейлисты и практически не несут в себе данных для фильтрации, сортировки.
  
  > It is not currently possible to add local files to playlists using the Web API, but they can be reordered or removed.

- Количество треков 
  - При добавлении в плейлист до 11 тысяч треков.
  - При получении с одного плейлиста также 11 тысяч.
  - Любимые треки до 20 тысяч.
  - При фильтрации, сортировке, выборе количество неограниченно. Но в пределах квоты Apps Script.
- Количество плейлистов
  - Теоретически до 11 тысяч, но не хватит квоты Apps Script на получение треков с них. Реальное значение в пределах 2 тысяч. Зависит от общего количества треков.
- Количество запросов
  - Точного числа нет. При слишком большом объеме запросов за короткий промежуток времени могут появиться ошибки 500, 503 и подобное. Проходят после паузы. 
  
### Google Диск {docsify-ignore}
- Размер одного текстового файла ограничен - 50 мб. Для сокращения объема можно использовать [Cache.compressTracks](/func?id=compresstracks). Экспериментально удалось забить файл 100 тысячами **сжатых** треков и уложиться в 50 мб.

## История прослушиваний

В Spotify Web API есть метод для получения истории прослушиваний. Но он позволяет получить *максимум* 50 последних треков, которые прослушаны более чем 30 секунд. В историю не попадают подкасты и треки, прослушанные в приватном режиме.

Goofy автоматически отслеживает историю прослушиваний вплоть до 20 тысяч треков. При достижении предела, новые прослушивая по-прежнему сохраняются за счет удаления самых старых. Процесс отслеживания начинается сразу после завершения настройки Goofy. Дубликаты не удаляются. 

Такая возможность появляется за счет платформы Google Apps Script и её доступа к Google Drive. В нем хранится файл с историей прослушиваний. Goofy переодически обращается к Spotify и обновляет содержимое файла новыми данными. Теоретический период обновления равен 25 минутам (30 секунд умножить на лимит 50 треков). Практически же обновление запрашивается каждые 15 минут. Такое значение продиктовано как наиболее близкое и допустимое платформой Apps Script.

Теоретически, лимит может быть и 30, и 100 тысячами. Но возникает вопрос производительности в рамках лимитов платформы Apps Script, доступности дискового пространства Drive и в целом целесообразности такого массива. Работа с текущим лимитов в 20 тысяч покажет насколько теория реализуема на практике.

Дополнительно, доступна история прослушиваний с Last.fm. Подробнее в справочнике.

Суммирующим и **рекомендованным** является [RecentTracks.get](/func?id=get).

> ❗️ На практике, Spotify API работает нестабильно. Трек после 30 секунд может вернуться с задержкой или совсем потеряться. Подробнее читать [отсюда](https://4pda.ru/forum/index.php?s=&showtopic=715234&view=findpost&p=101348829) и далее.
