# Audiolist

Начиная с версии `2.1` goofy умеет принимать запросы от [андроид приложения Audiolist](https://play.google.com/store/apps/details?id=ru.chimildic.audiolist) и возвращать ответ при необходимости.

## Настройка

### goofy

1. Обновите goofy до последней версии ([файл library](https://github.com/Chimildic/goofy/blob/main/library.js)). Для перехода с версии `1.x` на `2.x` воспользуйтесь [миграцией](/migrate2).
2. В редакторе кода нажмите _начать развертывание_ > _новое развертывание_. Убедитесь, что выбрана конфигурация с веб-приложением и доступом для всех. Нажмите _начать развертывание_.

   ![Новое развертывание](/img/new-deploy-audiolist.png ':size=60%')

3. Скопируйте `идентификатор развертывания` и удобным вам способом перенесите на устройство где установлен Audiolist.

   !> Не передавайте идентификатор другим пользователям. Они смогут запускать ваши функции.

### Audiolist

1. Создайте программу в Audiolist и добавьте команду `функция goofy`. 
2. Укажите `идентификатор развертывания`, полученный при настройке goofy. В качестве _имени функции_ для примера используем `Audiolist.hello`.

  ![Команда "Функция goofy"](/img/goofy-command-audiolist.jpg ':size=60%')

3. Выйдите из редактора программы и запустите выполнение программы. Если все сделано верно, в логах появится сообщение от goofy.

## Использование

Важно три вещи:

1. Правильное имя функции в настройках команды. Регистр букв имеет значение.
2. Возврат результата. Audiolist использует типизированный язык программирования и ожидает строгий формат ответа.
3. Обновление развертывания при любом изменении кода goofy. Развертывание - это изолированная копия. Если добавить/изменить функцию и не обновить развертывание, Audiolist не сможет её вызвать.

### Пустой ответ

```js
function doSomething() {
    // Алгоритм вашей функции
    // ...

    // Возврат результата
    return Audiolist.response()
}
```

### Возврат текста

Помимо текста можно указать тип: обычное, предупреждение, ошибка. От типа зависит цвет сообщения в логах. При типе _ошибка_ программа в Audiolist прервется.

```js
function doSomethingMessage() {
    // Алгоритм вашей функции
    // ...

    let text = "Этот текст появится в логах Audiolist"
    return Audiolist.responseMessage(text, Audiolist.MESSAGE_TYPES.WARNINNG)
}
```

### Возврат треков

Чтобы Audiolist смог преобразовать массив элементов от goofy в понятный для себя формат, необходимо указать один из типов `Audiolist.VARIABLE_TYPES`. Пример кода ниже возвращает 20 любимых Spotify треков. Однако на практике в такой функции нет смысла. Audiolist имеет свои команды для сбора треков. Проще получить те же любимые треки не прибегая к goofy. Но будет полезно для импорта других источников (кэш, радио и прочее).

```js
function doSomethingItems() {
    let tracks = Source.getSavedTracks(20)
    // ...

    return Audiolist.responseItems(tracks, Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK)
}
```

### Получение треков

Доступна отправка нескольких переменных из Audiolist. В goofy это будет массив объектов по пути `data.inputVariables`. Для получения массива треков по имени переменной используйте функцию `getItems`.

```js
function complexExample(data) {
    let tracksFromAudiolist = data.getItems('Имя переменной как в Audiolist')
    // ...

    let tracks = // ...

    return Audiolist.response({
        message: 'Сообщение для логов',
        messageType: Audiolist.MESSAGE_TYPES.DEFAULT,
        variableType: Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK,
        items: tracks,
    })
}
```

### Получение параметров

На стороне Audiolist есть поле `параметры` в `ini` формате. На стороне goofy данные парсятся в объект по пути `data.ini`. Необработанные данные по пути `data.iniRaw`.

В `ini` формате на каждой строке находятся пары вида `ключ=значение`. Имя ключа произвольно, но без пробелов и на английском. Регистр букв важен.

Например, задача получить от goofy 50 треков из файла с кэшем. Чтобы функция получилась универсальной, имя файла и количество треков сделаем параметрами.

```
filename=SavedTracks
count=50
```

```js
function getTracksFromCache(data) {
    let tracks = Cache.read(data.ini.filename)
    return Audiolist.response({
        message: `${data.ini.count} треков из файла "${data.ini.filename}"`,
        messageType: Audiolist.MESSAGE_TYPES.DEFAULT,
        variableType: Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK,
        items: Selector.sliceFirst(tracks, data.ini.count),
    })
}
```

В более сложных сценариях может понадобиться массив или вложенные объекты. Значения массива разделяются запятой. Вложенные объекты создаются точкой.

```
array=a,b,c
playlist.other.test=false

[playlist]
name=Имя плейлиста
description=Описание

[playlist.counters]
size=10
likes=3
```

В результате goofy создаст объект со следующей структурой.
```
{
    array: ["a", "b", "c"],
    playlist: {
        name: "Имя плейлиста",
        description: "Описание",
        other: {
            test: false
        }
        counters: {
            size: 10,
            likes: 3
        }
    }
}
```

## Обновление развертывания

Нажмите _начать развертывание_ > _управление развертываниями_. В левом списке выберите Audiolist, нажмите кнопку редактирования. Выберите _новую версию_ в списке и нажмите _начать развертывание_.

Иногда Apps Script сбрасывает названия развертываний (похоже на баг). Вам нужно обновлять то развертывание, идентификатор которого указан в команде "Функция goofy".

   ![Новое развертывание](/img/update-deploy-audiolist.png ':size=60%')

### Архив развертываний

Старые версии развертываний попадают в архив. Apps Script устанавливает лимит на количество развертываний (~200). Если вам укажут на лимит или просто накопилось много ненужных версий, в левом меню Apps Script выберите _история версий_. Справа появится список _история проекта_. Внизу списка есть кнопка _массового удаления версий_. Актуальную версию не удалит.
