# Audiolist

goofy `2.1+` умеет взаимодействовать с [андроид приложением Audiolist](https://play.google.com/store/apps/details?id=ru.chimildic.audiolist). Приложение может как просто запустить любую функцию goofy, так и выстроить сложное взаимодействие с передачей параметров и треков.

## Настройка

### goofy

1. Обновите goofy до последней версии ([файл library](https://github.com/Chimildic/goofy/blob/main/library.js)). Для перехода с версии `1.x` на `2.x` воспользуйтесь [миграцией](/migrate2).
2. В редакторе кода нажмите _начать развертывание_ > _новое развертывание_. Убедитесь, что выбрана конфигурация с веб-приложением и доступом для всех. Нажмите _начать развертывание_.

   ![Новое развертывание](/img/new-deploy-audiolist.png ':size=60%')

3. Скопируйте `идентификатор развертывания` и удобным вам способом перенесите на устройство где установлен Audiolist.

   !> Не передавайте идентификатор другим пользователям. Они смогут запускать ваши функции.

### Audiolist

1. Создайте программу в Audiolist и добавьте команду `Функция goofy`. 
2. Укажите `идентификатор развертывания` полученный при настройке goofy. В качестве _имени функции_ для примера напишите `Audiolist.hello` (встроенные функции доступны по кнопке <kbd>fx</kbd>).

  ![Команда "Функция goofy"](/img/goofy-command-audiolist.jpg ':size=60%')

1. Выйдите из редактора программы и запустите программу. Если все сделано верно, в логах появится сообщение от goofy.

## Важно

1. Правильное имя функции в настройках команды. Регистр букв имеет значение.
2. Возврат результата. Audiolist использует типизированный язык программирования и ожидает строгий формат ответа.
3. Обновление развертывания при любом изменении кода goofy. Развертывание - это изолированная копия. Если добавить/изменить функцию и не обновить развертывание, Audiolist не сможет её вызвать.

## Обновление развертывания

Нажмите _начать развертывание_ > _управление развертываниями_. В левом списке выберите Audiolist, нажмите кнопку редактирования. Выберите _новую версию_ в списке и нажмите _начать развертывание_.

Иногда Apps Script сбрасывает названия развертываний (похоже на баг). Вам нужно обновлять то развертывание, идентификатор которого указан в команде "Функция goofy".

   ![Новое развертывание](/img/update-deploy-audiolist.png ':size=60%')

### Архив развертываний

Старые версии развертываний попадают в архив. Apps Script устанавливает лимит на количество развертываний (~200). Если вам укажут на лимит или просто накопилось много ненужных версий, в левом меню Apps Script выберите _история версий_. Справа появится список _история проекта_. Внизу списка есть кнопка _массового удаления версий_. Актуальную версию не удалит.


## Использование

### Запуск функции

Когда нужен _только_ запуск функции, верните пустой ответ. Имя функции `doSomething` указывается в соответствующем поле команды `Функция goofy`.

```js
function doSomething() {
    // Алгоритм функции
    // ...

    return Audiolist.response()
}
```

### Ответ на запуск

#### Сообщение

Чтобы вернуть результат в виде сообщения, укажите текст и тип. От типа зависит цвет текста в логах программы: обычное - `DEFAULT`, предупреждение - `WARNINNG`, ошибка - `ERROR`. При выборе типа `ERROR` программа на стороне Audiolist прервется. 

```js
function doSomethingMessage() {
    // Алгоритм функции
    // ...

    let text = "Этот текст появится в логах Audiolist"
    return Audiolist.responseMessage(text, Audiolist.MESSAGE_TYPES.WARNINNG)
}
```

#### Треки

Чтобы Audiolist мог принять треки от goofy, необходимо указать их тип: треки Spotify - `SPOTIFY_TRACK`, last.fm треки - `LASTFM_TRACK`, треки в виде построчного текста - `TEXT_TRACK`.


```js
function doSomethingItems() {
    let tracks = Source.getSavedTracks(20)
    // ...

    return Audiolist.responseItems(tracks, Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK)
}
```

### Получение данных

Функция принимает аргумент `data`, который содержит `inputVariables` с массивом переменных и объект `ini` с параметрами от Audiolist.

#### Переменные

Используйте функциию `data.getItems` чтобы получить массив элементов по имени переменной. 
Для получениях всех элементов сразу - функцию `data.combineItems`. Обратите внимание, что во втором случае тип всех переменных должен быть одинаковым. Например, нельзя смешивать треки разных платформ.

```js
function complexExample(data) {
    let variableItems = data.getItems('Имя переменной как в Audiolist')
    let allItems = data.combineItems()

    let modifiedItems = // ...

    return Audiolist.response({
        message: 'Сообщение для логов',
        messageType: Audiolist.MESSAGE_TYPES.DEFAULT,
        variableType: Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK,
        items: modifiedItems,
    })
}
```

#### Параметры

В команде `Функция goofy` есть поле `параметры` для отправки строк и чисел. 

Поле заполняется в формате `ini`: на каждой строке указывается пара `key=value`, где `key` ключ для идентификации параметра, `value` значение. Имя ключа произвольно, но без пробелов и на английском. Регистр букв важен.

Например, задача получить от goofy 50 треков из файла с кэшем. Чтобы функция получилась универсальной, имя файла `filename` и количество треков `count` сделаем параметрами.

```
filename=SavedTracks
count=50
```

Тогда функция получит их по пути `data.ini.filename` и `data.ini.count`. В результате можно менять файл и количество только в приложении. Функция `getTracksFromCache` остается неизменной.

```js
function getTracksFromCache(data) {
    let tracks = Cache.read(data.ini.filename)

    return Audiolist.response({
        message: `${data.ini.count} треков из файла "${data.ini.filename}"`,
        messageType: Audiolist.MESSAGE_TYPES.DEFAULT,
        variableType: Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK,
        items: Selector.sliceFirst(tracks, data.ini.count),
    })
}
```

В более сложных сценариях может понадобиться массив или вложенные объекты. Значения массива разделяются запятой. Вложенные объекты создаются точкой.

```
array=a,b,c
playlist.other.test=false

[playlist]
name=Имя плейлиста
description=Описание

[playlist.counters]
size=10
likes=3
```

В результате получится `data.ini` со следующей структурой.
```
{
    array: ["a", "b", "c"],
    playlist: {
        name: "Имя плейлиста",
        description: "Описание",
        other: {
            test: false
        }
        counters: {
            size: 10,
            likes: 3
        }
    }
}
```

### Встроенные функции

В приложении есть быстрый выбор встроенных функций, которые находятся в модуле `Audiolist`.

- `Audiolist.hello` - возвращает текствое сообщение, чтобы проверить связь с goofy. 
  - `username` - тестовый параметр для проверки того как работать с параметрами.
- `Audiolist.getRecentTracks` - возвращает историю прослушиваний от `RecentTracks.get`.
  - `limit` - ограничение количества треков, необязательно.
  - `sinceDays` и `beforeDays` - фильтр по относительной дате, необязательно.
- `Audiolist.syncRecentTracks` - синхронизация истории прослушиваний. Предполагается, что Audiolist отправит историю из мониторинга за день, чтобы эта функция добавила их в кэш goofy. Также функция вернет историю goofy за день, чтобы Audiolist мог дополнитить свою историю (отдельной командой). Поскольку приложению недоступны прослушивания с других устройств.
  - `sinceDays` и `beforeDays` - регулировка периода истории, по умолчнаию текущий день.
- `Audiolist.readCache` - чтение файла кэша.
  - `filename` - имя файла.
  - `limit` - ограничение количества элементов, необязательно.
  - `sinceDays` и `beforeDays` - фильтр по относительной дате, необязательно.
- `Audiolist.writeCache` - запись в файл кэша.
  - `filename` - имя файла.
- `Audiolist.appendCache` - добавить к элементам кэша.
  - `filename` - имя файла.
  - `place` - добавить в начало `begin` или в конец `end`.