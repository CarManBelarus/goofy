<!DOCTYPE html>
<html>
    <head>
        <base target="_top" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" />
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="list-group" id="list_function"></div>
                </div>
                <div class="col-lg-9 d-flex flex-column-reverse text-start" id="logger"></div>
            </div>
        </div>

        <div class="list-group" id="list_function"></div>

        <script>
            const func = [
                {
                    name: 'createSavedAndForgot',
                    text: 'Обновить плейлист забытых любимых треков',
                },
                {
                    name: 'removeRecentTracks',
                    text: 'Удалить недавние треки',
                    args: [{ key: 'playlistUrl', name: 'Ссылка на плейлист', }],
                },
                {
                    name: 'updateRadio',
                    text: 'Радио',
                    args: [
                        {
                            key: 'station',
                            select: [
                                { value: 'evropa-plyus-light', name: 'Европа Плюс Лайт' },
                                { value: 'energy', name: 'Радио ENERGY' },
                            ],
                        },
                        { 
                            key: 'customStation', 
                            name: 'Кастомная станция' 
                        },
                        {
                            checkbox: [
                                { value: 'isRemoveHistory', name: 'Удалить историю прослушиваний' },
                                { value: 'isDedup', name: 'Удалить дубликаты' },
                            ],
                        },
                    ],
                },
            ];

            fillListFunction();

            function fillListFunction() {
                let list = document.getElementById('list_function');
                func.forEach((obj) => {
                    let item = createItemListFunction(obj);
                    list.insertAdjacentElement('beforeEnd', item);
                });
            }

            function createItemListFunction(obj) {
                let link = document.createElement('a');
                if (obj.hasOwnProperty('args')) {
                    let subitem = createSubitem(obj);
                    link.insertAdjacentElement('afterbegin', subitem);
                    link.setAttribute('class', 'list-group-item');
                } else {
                    link.innerText = obj.text || obj.name;
                    link.addEventListener('click', () => call(obj.name));
                    link.setAttribute('class', 'list-group-item list-group-item-action');
                }
                return link;
            }

            function createSubitem(obj) {
                let html = createTitle(obj);
                obj.args.forEach((form, index) => {
                    if (form.hasOwnProperty('select')) {
                        html += createSelectForm(obj, form, index);
                    } else if (form.hasOwnProperty('checkbox')) {
                        html += createCheckboxForm(obj, form, index);
                    } else {
                        html += createTextForm(form.name, obj.name, index);
                    }
                });
                let button = createStartButton(obj);
                return createContainer(html, button);
            }

            function createTextForm(placeholder, dataName, index) {
                let html = `<input class="form-control" placeholder="${placeholder}" data-${dataName}="${index}"></input>`;
                return createInputGroup(html);
            }

            function createCheckboxForm(obj, formData, index) {
                let root = document.createElement('div');
                for (let i = 0; i < formData.checkbox.length; i++) {
                    let item = formData.checkbox[i];
                    let id = item.value + i;
                    let input = `<input data-${obj.name}=${index + i} class="form-check-input" type="checkbox" value="${item.value}" id="${id}">`;
                    let label = `<label class="form-check-label" for="${id}">${item.name}</label>`;
                    let checkbox = document.createElement('div');
                    checkbox.setAttribute('class', 'form-check');
                    checkbox.insertAdjacentHTML('beforeend', input + label);
                    root.insertAdjacentElement('beforeend', checkbox);
                }
                return createInputGroup(root.outerHTML);
            }

            function createSelectForm(obj, formData, index) {
                let select = document.createElement('select');
                select.setAttribute('class', 'form-select');
                select.setAttribute(`data-${obj.name}`, index);
                for (let i = 0; i < formData.select.length; i++) {
                    let item = formData.select[i];
                    let option = `<option value="${item.value}">${item.name}</option>`;
                    select.insertAdjacentHTML('beforeend', option);
                }
                return createInputGroup(select.outerHTML);
            }

            function createTitle(obj) {
                return `<p style="color: #495057;">${obj.text || obj.name}</p>`;
            }

            function createStartButton(obj) {
                let button = document.createElement('button');
                button.setAttribute('class', 'btn btn-primary');
                button.innerText = 'Запустить';
                button.addEventListener('click', () => call(obj.name, true));
                return button;
            }

            function createInputGroup(html) {
                return `<div class="input-group mb-3">${html}</div>`;
            }

            function createContainer(html, button) {
                let container = document.createElement('div');
                container.setAttribute('class', 'input-group mb-3');
                container.insertAdjacentHTML('afterbegin', html);
                container.insertAdjacentElement('beforeend', button);
                return container;
            }

            function call(name, hasArgs) {
                let values = collectArgs(name, hasArgs);
                google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onError).withUserObject(name)[name](values);
                console.log(getTime(), 'Запущено', name);
            }

            function collectArgs(name, hasArgs) {
                let values = {};
                if (!hasArgs) return [];
                let indexFormData = func.findIndex((obj) => obj.name == name);
                let formData = func[indexFormData];
                document.querySelectorAll(`[data-${name}]`).forEach((el) => {
                    let index = el.getAttribute(`data-${name}`);
                    let data = formData.args[index];
                    if (el.classList.contains('form-check-input')) {
                        values.check = values.check || {};
                        values.check[el.value] = el.checked;
                    } else if (el.classList.contains('form-select')) {
                        values.select = values.select || {};
                        values.select[data.key] = el.value;
                    } else {
                        values.text = values.text || {};
                        values.text[data.key] = el.value;
                    }
                });
                return values;
            }

            function onSuccess(response, name) {
                console.log(getTime(), 'Завершено', name);
            }

            function onError(response, name) {
                console.log(getTime(), 'Ошибка в', name);
            }

            function getTime() {
                return new Date().toLocaleTimeString() + ' |';
            }
        </script>
        <script>!(function (o) { (console.old = console.log), (console.log = function () { var n, e, l = '<div class="p-2">'; for (e = 0; e < arguments.length; e++) (l += '<span class="log-' + typeof (n = arguments[e]) + '">'), 'object' == typeof n && 'object' == typeof JSON && 'function' == typeof JSON.stringify ? (l += JSON.stringify(n)) : (l += n), (l += '</span> '); (o.innerHTML += l + '</div>'), console.old.apply(void 0, arguments); }); })(document.getElementById('logger'));</script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
